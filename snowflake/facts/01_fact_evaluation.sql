-- =====================================================
-- FACT_EVALUATION - Evaluation Fact Table
-- =====================================================
-- Purpose: Core fact table for medical evaluations
-- Grain: One row per evaluation per medical condition

USE SCHEMA VETERAN_EVALUATION_DW.FACT;

CREATE OR REPLACE TABLE FACT_EVALUATION (
    EVALUATION_FACT_KEY INTEGER AUTOINCREMENT PRIMARY KEY,

    -- Foreign Keys to Dimensions
    VETERAN_KEY INTEGER NOT NULL,
    EVALUATOR_KEY INTEGER NOT NULL,
    FACILITY_KEY INTEGER NOT NULL,
    EVALUATION_TYPE_KEY INTEGER NOT NULL,
    MEDICAL_CONDITION_KEY INTEGER NOT NULL,
    CLAIM_KEY INTEGER NOT NULL,
    APPOINTMENT_KEY INTEGER,

    -- Date Foreign Keys
    EVALUATION_DATE_KEY INTEGER NOT NULL,
    SCHEDULED_DATE_KEY INTEGER,
    CLAIM_DATE_KEY INTEGER,

    -- Degenerate Dimensions (transaction identifiers)
    EVALUATION_ID VARCHAR(50) NOT NULL UNIQUE,
    DBQ_FORM_ID VARCHAR(50),
    EXAM_REQUEST_ID VARCHAR(50),

    -- Evaluation Metrics
    EVALUATION_DURATION_MINUTES INTEGER,
    SCHEDULED_DURATION_MINUTES INTEGER,
    VARIANCE_MINUTES INTEGER,  -- Actual vs Scheduled

    -- Attendance Metrics
    ATTENDED_FLAG BOOLEAN DEFAULT TRUE,
    NO_SHOW_FLAG BOOLEAN DEFAULT FALSE,
    CANCELLED_FLAG BOOLEAN DEFAULT FALSE,
    RESCHEDULED_FLAG BOOLEAN DEFAULT FALSE,

    -- Wait Time Metrics
    DAYS_FROM_REQUEST_TO_SCHEDULE INTEGER,
    DAYS_FROM_SCHEDULE_TO_EVALUATION INTEGER,
    TOTAL_WAIT_DAYS INTEGER,

    -- Evaluation Results
    EVALUATION_COMPLETED_FLAG BOOLEAN DEFAULT FALSE,
    DBQ_SUBMITTED_FLAG BOOLEAN DEFAULT FALSE,
    DBQ_SUBMISSION_DATE DATE,
    NEXUS_OPINION_PROVIDED BOOLEAN DEFAULT FALSE,
    NEXUS_OPINION VARCHAR(50),  -- At Least As Likely As Not, Less Likely, etc.

    -- Disability Assessment
    CURRENT_SEVERITY VARCHAR(50),
    FUNCTIONAL_IMPACT_SCORE INTEGER,  -- 0-100 scale
    RECOMMENDED_RATING_PERCENTAGE INTEGER,

    -- Service Connection Assessment
    SERVICE_CONNECTED_OPINION VARCHAR(50),  -- Yes, No, Possible
    IN_SERVICE_INCURRENCE_FLAG BOOLEAN,
    AGGRAVATION_FLAG BOOLEAN,
    SECONDARY_CONDITION_FLAG BOOLEAN,

    -- Quality Metrics
    REPORT_COMPLETENESS_SCORE DECIMAL(5,2),  -- 0-100
    REPORT_TIMELINESS_DAYS INTEGER,
    SUFFICIENT_EXAM_FLAG BOOLEAN DEFAULT TRUE,
    ADDENDUM_REQUIRED_FLAG BOOLEAN DEFAULT FALSE,

    -- Financial Metrics
    EVALUATION_COST_AMOUNT DECIMAL(10,2),
    CONTRACTOR_PAYMENT_AMOUNT DECIMAL(10,2),
    TRAVEL_REIMBURSEMENT_AMOUNT DECIMAL(10,2),

    -- Administrative
    REVIEW_REQUIRED_FLAG BOOLEAN DEFAULT FALSE,
    QA_REVIEWED_FLAG BOOLEAN DEFAULT FALSE,
    QA_REVIEWER_ID VARCHAR(50),
    QA_REVIEW_DATE DATE,

    -- Telehealth Specific
    TELEHEALTH_FLAG BOOLEAN DEFAULT FALSE,
    TELEHEALTH_PLATFORM VARCHAR(50),
    TECHNICAL_ISSUES_FLAG BOOLEAN DEFAULT FALSE,

    -- Metadata
    SOURCE_SYSTEM VARCHAR(50),
    CREATED_TIMESTAMP TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_TIMESTAMP TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),

    -- Foreign Key Constraints
    FOREIGN KEY (VETERAN_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_VETERAN(VETERAN_KEY),
    FOREIGN KEY (EVALUATOR_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_EVALUATOR(EVALUATOR_KEY),
    FOREIGN KEY (FACILITY_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_FACILITY(FACILITY_KEY),
    FOREIGN KEY (EVALUATION_TYPE_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_EVALUATION_TYPE(EVALUATION_TYPE_KEY),
    FOREIGN KEY (MEDICAL_CONDITION_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_MEDICAL_CONDITION(MEDICAL_CONDITION_KEY),
    FOREIGN KEY (CLAIM_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_CLAIM(CLAIM_KEY),
    FOREIGN KEY (APPOINTMENT_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_APPOINTMENT(APPOINTMENT_KEY),
    FOREIGN KEY (EVALUATION_DATE_KEY) REFERENCES VETERAN_EVALUATION_DW.DIM.DIM_DATE(DATE_KEY)
)
COMMENT = 'Transaction fact table for medical evaluations at the evaluation-condition grain'
CLUSTER BY (EVALUATION_DATE_KEY, FACILITY_KEY);
